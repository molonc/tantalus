<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Pseudobulk Form</title>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet">
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script> -->
</head>

<body>
    <v-app id="pseudobulk-form">
        <v-container class="ma-0 pa-0" fluid>
            <template v-if="!confirmation">
                <v-row justify="center" align="center">
                    <v-col cols="8">
                        <h2>Pseudobulk Submission Form</h2>
                        <v-alert v-if="!formFilled" outlined type="warning" border="left">
                            {% verbatim %} {{errorMsg}} {% endverbatim %}
                        </v-alert>
                        <v-row align="center" justify="space-between">
                            <!-- <v-col cols="4">
                                <v-text-field v-model="tag" label="Tag" :color="color"></v-text-field>
                            </v-col> -->
                            <v-col>
                                <v-combobox v-model="selectedTag" :items="tags" label="Search for tag or enter new tag name"></v-combobox>
                            </v-col>
                            <v-col cols="6">
                                <v-autocomplete v-model="alignerDefault" label="Aligner" return-object :items="aligners"
                                    :color="color">
                                </v-autocomplete>
                            </v-col>
                        </v-row>
                        <v-row>
                            <p class="ma-3">Select samples from dropdown or enter a list of samples in text box
                                seperated by
                                commas or spaces.</p>
                            <v-col cols="6">
                                <v-autocomplete v-model="selectedSamples" label="Samples" outlined chips clearable multiple
                                    return-object :items="samples" :color="color">
                                </v-autocomplete>
                            </v-col>
                            <v-col cols="6">
                                <p style="color: #e36056" v-if="inputSampleError"> {%verbatim%} {{inputSampleError}}
                                    {% endverbatim%}</p>
                                <v-textarea v-model="inputSampleNames" :value="inputSamples" outlined full-width no-resize
                                    :color="color">
                                </v-textarea>
                            </v-col>
                        </v-row>
                        <v-row>
                            <p class="ma-3">Select libraries from dropdown or enter a list of libraries in text box
                                seperated by commas or spaces.</p>
                            <v-col cols="6">
                                <v-autocomplete v-model="selectedLibraries" label="Libraries" outlined chips clearable multiple
                                    return-object :items="libraries" :color="color">
                                </v-autocomplete>
                            </v-col>
                            <v-col cols="6">
                                <v-textarea v-model="inputLibraryNames" :value="inputLibraries" :color="color" outlined
                                    full-width no-resize :color="color">
                                </v-textarea>
                            </v-col>
                        </v-row>
        
                        <v-row align="center" justify="space-between">
                            <v-col cols="6">
                                <v-autocomplete v-model="selectedNormalSample" :color="color" label="Normal Sample"
                                    :items="selectedSamples" clearable return-object outlined
                                    no-data-text="Please select samples above in order to choose a normal">
                                    <template v-slot:no-data="No"></template>
                                </v-autocomplete>
                            </v-col>
                        </v-row>
                        <v-row>
                            <v-col cols="6">
                                <v-autocomplete v-model="selectedNormalLibrary" :color="color" label="Normal Library"
                                    :items="selectedLibraries" clearable return-object outlined
                                    no-data-text="Please select libraries above in order to choose a normal">
                                </v-autocomplete>
                            </v-col>
                        </v-row>
                        <v-btn absolute right @click="submitForm" :color="color" style="color: white">Submit</v-btn>
                    </v-col>
                </v-row>
            </template>
            <template v-else>
                <v-row justify="center" align="center">
                    <v-col cols="8">
        
                        </v-btn>
                        <h2>Confirmation</h2>
                        <template class="ma-2 pa-2" v-if="librariesToRun.length !== 0">
                            <h5 style="color: #9e8ae3">Normal pair chosen: </h5>
                            <v-card class="ma-2 pa-0">
                                <v-card-text>{% verbatim %} {{normalPair.sample}} - {{normalPair.library}} {% endverbatim %}
                                </v-card-text>
                            </v-card>
                            <h5 style="color: #9e8ae3">The following libraries have already been ran through QC:</h5>
                            <v-card class="ma-2 pa-0">
                                <template v-for="library in librariesAnalyzed">
                                    <v-card-text>{% verbatim %} {{library}} {% endverbatim %}</v-card-text>
                                </template>
                            </v-card>
                            <h5 style="color: #9e8ae3">The following libraries will be queued for analysis:</h5>
                            <v-card class="ma-2 pa-0" v-if="librariesToRun.length !== 0">
                                <template v-for="library in librariesToRun">
                                    <v-card-text>{% verbatim %} {{library}} {% endverbatim %}</v-card-text>
                                </template>
                            </v-card>
                            <template class="ma-2 pa-2">
                                <v-btn relative right @click="cancelConfirmation" outlined color="grey">Cancel</v-btn>
                                <v-btn absolute right @click="createAnalyses" :color="color" style="color: white">Let's go!
                                </v-btn>
                            </template>
                        </template>
        
                        <template v-else class="ma-2 pa-2">
                            <v-card class="ma-2 pa-0">
                                <template>
                                    <v-card-text>All libraries requested have already been ran with the latest major version of
                                        the single cell
                                        pipeline.</v-card-text>
                                </template>
                            </v-card>
                            <v-btn relative right @click="cancelConfirmation" outlined color="grey">Cancel</v-btn>
                            <v-btn absolute right @click="backToHomepage" :color="color" style="color: white">Great! Back to Homepage
                            </v-btn>
                        </template>
                    </v-col>
                </v-row>
        
        
            </template>
        </v-container>

    </v-app>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script type="text/javascript">
        new Vue({
            el: '#pseudobulk-form',
            vuetify: new Vuetify(),
            data() {
                return {
                    color: "#9e8ae3",
                    tag: "",
                    samples: [],
                    libraries: [],
                    selectedTag: [], 
                    selectedSamples: [],
                    selectedLibraries: [],
                    inputSamples: [],
                    inputLibraries: [],
                    normalSample: [],
                    normalLibrary: [],
                    allSamplesNames: [],
                    allLibraryNames: [],
                    formFilled: true,
                    fieldsToFill: [],
                    errorMsg: "",
                    inputSampleError: "",
                    confirmation: false,
                    results: "",
                    alignerDefault: {
                        text: "BWA_MEM_0_7_6A",
                        value: 1,
                    },
                    aligners: [
                        {
                            text: "BWA_MEM_0_7_6A",
                            value: 1,
                        },
                        {
                            text: "BWA_ALN_0_5_7",
                            value: 2,
                        },
                    ]
                }
            },
            computed: {
                inputSampleNames: {
                    get() {
                        return this.inputSamples.join("\n")
                    },

                    set(input) {
                        this.inputSamples = input.split(/[\s,]+/)
                        console.log("samples after splitting")

                        if (!!input) {
                            console.log(input)
                            return
                        }
                        console.log("sample input is empty")
                        this.inputSampleError = ""
                    }
                },
                inputLibraryNames: {
                    get() {
                        return this.inputLibraries.join("\n")
                    },

                    set(input) {
                        let inputLibraries = input.split(/[\s,]+/)
                        console.log("libraries after splitting")
                        console.log(inputLibraries)

                        this.inputLibraries = inputLibraries
                        if (!!input) {
                            console.log(input)
                            return
                        }
                        console.log("library input is empty")
                    }
                },
                selectedNormalSample: {
                    get() {
                        if (!this.selectedSamples.length) {
                            console.log("no normal sample options")
                            this.normalSample = []
                            return []
                        }
                        console.log("currently normal is ")
                        console.log(this.normalSample)
                        if (!this.selectedSamples.includes(this.normalSample)) {
                            console.log()
                            this.normalSample = []
                            return this.selectedSamples
                        }
                        return this.normalSample
                    },
                    set(input) {
                        console.log("normal sample selected is:")
                        console.log(input)
                        this.normalSample = input
                    }
                },
                selectedNormalLibrary: {
                    get() {
                        if (!this.selectedLibraries.length) {
                            console.log("no normal library options")
                            return []
                        }
                        if (!this.selectedLibraries.includes(this.normalLibrary)) {
                            console.log()
                            this.normalLibrary = []
                            return this.selectedLibraries
                        }
                        return this.normalLibrary
                    },

                    set(input) {
                        console.log("normal selected is:")
                        console.log(input)
                        this.normalLibrary = input
                    }
                },
            },

            methods: {
                validateForm: function () {
                    console.log(this.selectedSamples)
                    this.errorMsg = "Please fill out the following fields: "
                    console.log(!!this.tag)
                    console.log(!!this.normalSample )
                    console.log(!!this.normalLibrary)
                    console.log(!!this.selectedSamples.length)
                    console.log(!!this.selectedLibraries.length)
                    console.log(!!this.alignerDefault)

                    if (!!this.selectedTag && !!this.normalSample && !!this.normalLibrary && (!!this.selectedSamples || !!this.inputSamples) && (!!this.selectedLibraries || !!this.inputLibraries) && !!this.alignerDefault) {
                        this.formFilled = true
                        console.log("tag")
                        console.log(this.selectedTag)
                        console.log("normal sample")
                        console.log(this.normalSample)
                        console.log("selected samples")
                        console.log(this.selectedSamples)
                        console.log("selected libraries")
                        console.log(this.normalLibrary)
                        console.log("selected aligner")
                        console.log(this.alignerDefault)
                        return true
                    }
                    // Check if required fields have not been filled out
                    let allFields = ["Tag", "Aligner", "Samples", "Libraries", "Normal Sample", "Normal Library"]
                    var fieldsMap = {
                        Samples: this.selectedSamples,
                        Libraries: this.selectedLibraries,
                        Tag: this.selectedTag,
                        "Normal Sample": this.normalSample,
                        "Normal Library": this.normalLibrary,
                        "Aligner": this.alignerDefault,
                    }
                    this.fieldsToFill = []
                    this.formFilled = false
                    console.log("fields needs to be filled")
                    allFields.forEach((item) => {
                        let field = fieldsMap[item]
                        console.log(item)
                        console.log(field)
                        if (Array.isArray(field)) {
                            console.log(`${item} is array`)
                            if (!field.length) {
                                // console.log(!field.length)
                                console.log(`adding ${item} to fields to fill`)
                                this.fieldsToFill.push(item)
                            }
                        }
                        else if (!field) {
                            console.log(`adding ${item} to fields to fill`)
                            this.fieldsToFill.push(item)
                        }
                    })
                    console.log(this.fieldsToFill)
                    this.errorMsg = this.errorMsg.concat(this.fieldsToFill.join(", "))
                    window.scrollTo(0, 0);
                    return false
                },
                submitForm: function () {
                    if (this.validateForm()) {
                        // add axios calls below
                        axios({
                            method: "post",
                            url: window.origin + "/create_pseudobulk_runs/",
                            dataType: "json",
                            data: {
                                tag: this.selectedTag,
                                aligner: this.alignerDefault,
                                samples: this.selectedSamples,
                                libraries: this.selectedLibraries,
                                normal_sample: this.normalSample,
                                normal_library: this.normalLibrary,
                                input_samples: this.inputSamples,
                                input_libraries: this.inputLibraries,
                            },
                            headers: {
                                "X-CSRFToken": Cookies.get('csrftoken'),
                                "content-type": "application/json"
                            }
                        }).then((response) => {
                            console.log("ok")
                            console.log(response)
                            this.results = response.data
                            if (this.results == "noNormal") {
                                this.errorMsg = `No normal dataset found for pair ${this.normalSample["text"]} - ${this.normalLibrary["text"]}`
                                this.formFilled = false
                                window.scrollTo(0, 0);
                            }

                            else {
                                this.librariesAnalyzed = JSON.parse(this.results["libraries_analyzed"])
                                this.librariesToRun = JSON.parse(this.results["libraries_to_run"])
                                this.normalPair = JSON.parse(this.results["normal_pair"])
                                console.log(this.librariesAnalyzed)
                                this.confirmation = true
                            }

                        }).catch((error) => {
                            console.log(error)
                        })
                    }

                },
                cancelConfirmation: function () {
                    this.confirmation = false
                },

                createAnalyses: function () {
                    axios({
                        method: "post",
                        url: window.origin + "/create_qc_analyses_for_pseudobulk/",
                        dataType: "json",
                        data: {
                            librariesToRun: this.librariesToRun,
                            aligner: this.alignerDefault
                        },
                        headers: {
                            "X-CSRFToken": Cookies.get('csrftoken'),
                            "content-type": "application/json"
                        }
                    }).then((response) => {
                        console.log("ok")
                        window.location.href = '/analyses/';
                    }).catch((error) => {
                        console.log(error)
                    })
                },
                backToHomepage: function() {
                    window.location.href = '/';
                }
            },


            created: function () {
                this.tags = JSON.parse(unescape("{{tags| safe | escapejs}}"))
                this.samples = JSON.parse(unescape("{{samples| safe | escapejs}}"))
                this.libraries = JSON.parse(unescape("{{libraries| safe | escapejs}}"))
                this.allSamplesNames = this.samples.map(sample => sample.text)
                this.allLibraryNames = this.libraries.map(library => library.text)
            },
        })
    </script>
</body>

</html>