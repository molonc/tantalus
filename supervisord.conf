[unix_http_server]
file=%(here)s/tmp/supervisor.sock

[supervisord]
logfile=%(here)s/tmp/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=%(here)s/tmp/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200

[program:celeryd_transfer]
environment=PYTHONPATH="%(here)s:%(here)s/venv/lib/python2.7/site-packages/",
    TANTALUS_SECRET_KEY=%(ENV_TANTALUS_SECRET_KEY)s,
    TANTALUS_DEBUG=%(ENV_TANTALUS_DEBUG)s,
    TANTALUS_IS_PRODUCTION=%(ENV_TANTALUS_IS_PRODUCTION)s,
    TANTALUS_POSTGRESQL_NAME=%(ENV_TANTALUS_POSTGRESQL_NAME)s,
    TANTALUS_POSTGRESQL_USER=%(ENV_TANTALUS_POSTGRESQL_USER)s,
    TANTALUS_POSTGRESQL_PASSWORD=%(ENV_TANTALUS_POSTGRESQL_PASSWORD)s,
    TANTALUS_RABBIT_USER=%(ENV_TANTALUS_RABBIT_USER)s,
    TANTALUS_RABBIT_PASSWORD=%(ENV_TANTALUS_RABBIT_PASSWORD)s,
    TANTALUS_RABBIT_VHOST=%(ENV_TANTALUS_RABBIT_VHOST)s,
    TANTALUS_RABBIT_IP=%(ENV_TANTALUS_RABBIT_IP)s,
    TASK_LOG_DIRECTORY=%(here)s/tmp/logs/tasks/,
    GSC_API_URL=%(ENV_GSC_API_URL)s,
    GSC_API_USERNAME=%(ENV_GSC_API_USERNAME)s,
    GSC_API_PASSWORD=%(ENV_GSC_API_PASSWORD)s,
    COLOSSUS_API_URL=%(ENV_COLOSSUS_API_URL)s
command=%(here)s/venv/bin/celery -A tantalus worker -l DEBUG --queues %(ENV_TANTALUS_QUEUE_PREFIX)s.transfer -n %(ENV_TANTALUS_QUEUE_PREFIX)s.transfer --autoscale 9,1
stdout_logfile=%(here)s/tmp/logs/celeryd_transfer.log
stderr_logfile=%(here)s/tmp/logs/celeryd_transfer.log
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600

[program:celeryd_md5]
environment=PYTHONPATH="%(here)s:%(here)s/venv/lib/python2.7/site-packages/",
    TANTALUS_SECRET_KEY=%(ENV_TANTALUS_SECRET_KEY)s,
    TANTALUS_DEBUG=%(ENV_TANTALUS_DEBUG)s,
    TANTALUS_IS_PRODUCTION=%(ENV_TANTALUS_IS_PRODUCTION)s,
    TANTALUS_POSTGRESQL_NAME=%(ENV_TANTALUS_POSTGRESQL_NAME)s,
    TANTALUS_POSTGRESQL_USER=%(ENV_TANTALUS_POSTGRESQL_USER)s,
    TANTALUS_POSTGRESQL_PASSWORD=%(ENV_TANTALUS_POSTGRESQL_PASSWORD)s,
    TANTALUS_RABBIT_USER=%(ENV_TANTALUS_RABBIT_USER)s,
    TANTALUS_RABBIT_PASSWORD=%(ENV_TANTALUS_RABBIT_PASSWORD)s,
    TANTALUS_RABBIT_VHOST=%(ENV_TANTALUS_RABBIT_VHOST)s,
    TANTALUS_RABBIT_IP=%(ENV_TANTALUS_RABBIT_IP)s,
    TASK_LOG_DIRECTORY=%(here)s/tmp/logs/tasks/,
    GSC_API_URL=%(ENV_GSC_API_URL)s,
    GSC_API_USERNAME=%(ENV_GSC_API_USERNAME)s,
    GSC_API_PASSWORD=%(ENV_GSC_API_PASSWORD)s,
    COLOSSUS_API_URL=%(ENV_COLOSSUS_API_URL)s
command=%(here)s/venv/bin/celery -A tantalus worker -l DEBUG --queues %(ENV_TANTALUS_QUEUE_PREFIX)s.md5 -n %(ENV_TANTALUS_QUEUE_PREFIX)s.md5 --concurrency 1
stdout_logfile=%(here)s/tmp/logs/celeryd_md5.log
stderr_logfile=%(here)s/tmp/logs/celeryd_md5.log
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600

[program:celeryd_db]
environment=PYTHONPATH="%(here)s:%(here)s/venv/lib/python2.7/site-packages/",
    TANTALUS_SECRET_KEY=%(ENV_TANTALUS_SECRET_KEY)s,
    TANTALUS_DEBUG=%(ENV_TANTALUS_DEBUG)s,
    TANTALUS_IS_PRODUCTION=%(ENV_TANTALUS_IS_PRODUCTION)s,
    TANTALUS_POSTGRESQL_NAME=%(ENV_TANTALUS_POSTGRESQL_NAME)s,
    TANTALUS_POSTGRESQL_USER=%(ENV_TANTALUS_POSTGRESQL_USER)s,
    TANTALUS_POSTGRESQL_PASSWORD=%(ENV_TANTALUS_POSTGRESQL_PASSWORD)s,
    TANTALUS_RABBIT_USER=%(ENV_TANTALUS_RABBIT_USER)s,
    TANTALUS_RABBIT_PASSWORD=%(ENV_TANTALUS_RABBIT_PASSWORD)s,
    TANTALUS_RABBIT_VHOST=%(ENV_TANTALUS_RABBIT_VHOST)s,
    TANTALUS_RABBIT_IP=%(ENV_TANTALUS_RABBIT_IP)s,
    TASK_LOG_DIRECTORY=%(here)s/tmp/logs/tasks/,
    GSC_API_URL=%(ENV_GSC_API_URL)s,
    GSC_API_USERNAME=%(ENV_GSC_API_USERNAME)s,
    GSC_API_PASSWORD=%(ENV_GSC_API_PASSWORD)s,
    COLOSSUS_API_URL=%(ENV_COLOSSUS_API_URL)s
command=%(here)s/venv/bin/celery -A tantalus worker -l DEBUG --queues %(ENV_TANTALUS_QUEUE_PREFIX)s.db -n %(ENV_TANTALUS_QUEUE_PREFIX)s.db --concurrency 1
stdout_logfile=%(here)s/tmp/logs/celeryd_db.log
stderr_logfile=%(here)s/tmp/logs/celeryd_db.log
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600

[program:rsync_logs]
command=bash -c "while sleep 10; do rsync -rauv %(here)s/tmp/logs/tasks/ %(ENV_TASK_LOG_USERNAME)s@%(ENV_TASK_LOG_HOSTNAME)s:%(ENV_TASK_LOG_DIRECTORY)s; done"
stdout_logfile=%(here)s/tmp/logs/rsync_logs.log
stderr_logfile=%(here)s/tmp/logs/rsync_logs.log
autostart=true
autorestart=true
startsecs=10
stopwaitsecs=600

; The rpcinterface:supervisor section must remain in the config file for
; RPC (supervisorctl/web interface) to work.  Additional interfaces may be
; added by defining them in separate [rpcinterface:x] sections.

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix://%(here)s/tmp/supervisor.sock

